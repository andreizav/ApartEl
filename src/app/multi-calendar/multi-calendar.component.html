<div class="flex flex-col h-[calc(100vh-8rem)] animate-fade-in-up">
  
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-6">
    <div>
      <h1 class="text-3xl font-extrabold text-[#111418] dark:text-white tracking-tight">Multi-Calendar</h1>
      <p class="text-gray-500 dark:text-gray-400 mt-1">Availability and bookings across all channels.</p>
    </div>

    <!-- Controls -->
    <div class="flex items-center gap-4">
      
      <!-- Legend -->
      <div class="hidden xl:flex items-center gap-3 text-xs font-bold text-gray-500 mr-4">
        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-[#ff385c]"></span> Airbnb</div>
        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-[#003580]"></span> Booking.com</div>
        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-[#FFC400]"></span> Expedia</div>
        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-[#10b981]"></span> Direct</div>
      </div>

      <div class="flex items-center bg-white dark:bg-[#1c2936] rounded-lg border border-gray-200 dark:border-[#324d67] p-1 shadow-sm">
        <button (click)="changeMonth(-1)" class="p-2 hover:bg-gray-100 dark:hover:bg-[#253545] rounded-md transition-colors">
          <span class="material-symbols-outlined text-[20px]">chevron_left</span>
        </button>
        <div class="px-4 font-bold min-w-[140px] text-center text-[#111418] dark:text-white select-none">
          {{ formattedMonth() }}
        </div>
        <button (click)="changeMonth(1)" class="p-2 hover:bg-gray-100 dark:hover:bg-[#253545] rounded-md transition-colors">
          <span class="material-symbols-outlined text-[20px]">chevron_right</span>
        </button>
      </div>

      <button 
        (click)="goToToday()"
        class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-blue-600 transition-colors shadow-lg shadow-primary/20"
      >
        Today
      </button>
    </div>
  </div>

  <!-- Calendar Container -->
  <div class="flex-1 bg-white dark:bg-[#1c2936] rounded-xl border border-gray-200 dark:border-[#324d67] overflow-hidden flex flex-col shadow-sm">
    
    <!-- Timeline Header -->
    <div class="flex border-b border-gray-200 dark:border-[#324d67] bg-gray-50 dark:bg-[#111a22]">
      <!-- Sticky Corner -->
      <div class="w-48 flex-shrink-0 p-4 font-bold text-gray-500 uppercase text-xs border-r border-gray-200 dark:border-[#324d67] bg-gray-50 dark:bg-[#111a22] z-20">
        Unit / Property
      </div>
      
      <!-- Days Row -->
      <div #headerScroll class="flex-1 overflow-hidden relative">
        <div class="flex">
          @for (day of currentMonthDays(); track day.dayNum) {
            <div 
              class="flex-shrink-0 flex flex-col items-center justify-center border-r border-gray-100 dark:border-[#324d67] h-14"
              [style.width.px]="cellWidth"
              [class.bg-blue-50]="day.isToday"
              [class.dark:bg-blue-900/20]="day.isToday"
              [class.bg-gray-100]="day.isWeekend && !day.isToday"
              [class.dark:bg-[#18232e]]="day.isWeekend && !day.isToday"
            >
              <span class="text-[10px] uppercase font-bold text-gray-400">{{ day.dayName }}</span>
              <span 
                class="text-sm font-bold mt-0.5 w-6 h-6 flex items-center justify-center rounded-full"
                [class.bg-primary]="day.isToday"
                [class.text-white]="day.isToday"
                [class.text-[#111418]]="!day.isToday"
                [class.dark:text-white]="!day.isToday"
              >
                {{ day.dayNum }}
              </span>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Scrollable Body -->
    <div #bodyScroll (scroll)="onBodyScroll()" class="flex-1 overflow-y-auto overflow-x-auto relative">
      <div class="min-w-max pb-20">
        
        @for (group of calendarGroups(); track group.name) {
          
          <!-- Group Header Row -->
          <div 
             class="flex border-b border-gray-200 dark:border-[#324d67] bg-gray-50 dark:bg-[#1c2936] hover:bg-gray-100 dark:hover:bg-[#253545] transition-colors cursor-pointer group/header"
             (click)="toggleGroup(group.name)"
          >
             <!-- Sticky Header -->
             <div class="w-48 flex-shrink-0 px-4 py-2 flex items-center justify-between border-r border-gray-200 dark:border-[#324d67] sticky left-0 z-10 bg-gray-50 dark:bg-[#1c2936] group-hover/header:bg-gray-100 dark:group-hover/header:bg-[#253545]">
                <div class="flex items-center gap-2 overflow-hidden">
                   <span class="material-symbols-outlined text-[18px] text-yellow-500">folder</span>
                   <span class="font-bold text-xs uppercase text-gray-700 dark:text-gray-200 truncate">{{ group.name }}</span>
                </div>
                <div class="flex items-center gap-2">
                   <span class="text-[10px] bg-gray-200 dark:bg-[#111a22] text-gray-600 dark:text-gray-400 px-1.5 rounded font-bold">{{ group.units.length }}</span>
                   <span class="material-symbols-outlined text-[18px] text-gray-400 transition-transform duration-200" [class.-rotate-90]="!group.expanded">expand_more</span>
                </div>
             </div>
             
             <!-- Timeline Grid for Group (Visual filler) -->
             <div class="flex relative opacity-30">
                @for (day of currentMonthDays(); track day.dayNum) {
                   <div 
                      class="flex-shrink-0 border-r border-gray-300 dark:border-[#324d67] h-10"
                      [style.width.px]="cellWidth"
                   ></div>
                }
             </div>
          </div>

          <!-- Units Rows -->
          @if (group.expanded) {
             @for (unit of group.units; track unit.id) {
               <div class="flex border-b border-gray-100 dark:border-[#324d67] relative group hover:bg-gray-50 dark:hover:bg-[#253545] transition-colors">
                 
                 <!-- Fixed Column (Sticky) - Unit Name -->
                 <div 
                    (click)="navigateToProperty(unit.id)"
                    class="w-48 flex-shrink-0 p-3 pl-8 flex flex-col justify-center border-r border-gray-200 dark:border-[#324d67] bg-white dark:bg-[#1c2936] group-hover:bg-gray-50 dark:group-hover:bg-[#253545] sticky left-0 z-10 transition-colors cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/10"
                 >
                   <div class="font-bold text-sm text-[#111418] dark:text-white truncate group-hover:text-primary transition-colors" title="{{ unit.name }}">
                     {{ unit.name }}
                   </div>
                 </div>
     
                 <!-- Grid Cells -->
                 <div class="flex relative">
                   <!-- Background Grid -->
                   @for (day of currentMonthDays(); track day.dayNum) {
                     <div 
                       class="flex-shrink-0 border-r border-gray-100 dark:border-[#324d67] h-16"
                       [style.width.px]="cellWidth"
                       [class.bg-blue-50]="day.isToday"
                       [class.dark:bg-blue-900/10]="day.isToday"
                       [class.bg-gray-50]="day.isWeekend && !day.isToday"
                       [class.dark:bg-[#18232e]]="day.isWeekend && !day.isToday"
                     ></div>
                   }
     
                   <!-- Booking Bars Layer -->
                   <div class="absolute inset-0 top-2 bottom-2 pointer-events-none">
                      @for (booking of getBookingsForUnit(unit.id); track booking.id) {
                         <div 
                           class="absolute top-1 bottom-1 rounded-md shadow-sm border border-white/10 flex items-center px-2 overflow-hidden pointer-events-auto cursor-pointer hover:brightness-110 transition-all z-0"
                           [ngClass]="getBookingColor(booking.source)"
                           [ngStyle]="getBookingStyle(booking)"
                           title="{{ booking.guestName }} ({{ booking.source }})"
                           (click)="navigateToClient(booking)"
                         >
                            @if (booking.source !== 'blocked') {
                             <span class="text-[10px] font-bold truncate">{{ booking.guestName }}</span>
                            } @else {
                             <span class="material-symbols-outlined text-[14px]">block</span>
                            }
                         </div>
                      }
                   </div>
                 </div>
     
               </div>
             }
          }
        }
      </div>
    </div>
  </div>
</div>