<div class="flex min-h-screen bg-background-light dark:bg-background-dark">

  <!-- Sidebar Overlay for Mobile -->
  @if (sidebarOpen()) {
  <div class="fixed inset-0 z-20 bg-black/50 lg:hidden" (click)="toggleSidebar()"></div>
  }

  <!-- Sidebar -->
  <aside
    class="fixed inset-y-0 left-0 z-30 w-64 flex flex-col transform bg-white dark:bg-[#1c2936] border-r border-gray-200 dark:border-[#324d67] transition-transform duration-300 lg:static lg:translate-x-0"
    [class.translate-x-0]="sidebarOpen()" [class.-translate-x-full]="!sidebarOpen()">
    <!-- Logo -->
    <div class="flex items-center gap-3 px-6 h-16 border-b border-gray-200 dark:border-[#324d67] flex-shrink-0">
      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-primary text-white">
        <span class="material-symbols-outlined text-xl">apartment</span>
      </div>
      <span class="text-xl font-extrabold text-[#111418] dark:text-white">apartEl</span>
    </div>

    <!-- Nav Links -->
    <nav class="p-4 space-y-1 flex-1 overflow-y-auto">
      <a routerLink="/dashboard" [routerLinkActiveOptions]="{exact: true}" routerLinkActive="bg-primary/10 text-primary"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer"
        [class.text-[#637588]]="!isActive">
        <span class="material-symbols-outlined">dashboard</span>
        Dashboard
        <span #isActive="routerLinkActive" routerLinkActive></span>
      </a>

      <a routerLink="/dashboard/calendar" routerLinkActive="bg-primary/10 text-primary"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer">
        <span class="material-symbols-outlined">calendar_month</span>
        Multi-Calendar
      </a>

      <a routerLink="/dashboard/properties" routerLinkActive="bg-primary/10 text-primary"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer">
        <span class="material-symbols-outlined">domain</span>
        Properties
      </a>

      <a routerLink="/dashboard/clients" routerLinkActive="bg-primary/10 text-primary"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer">
        <span class="material-symbols-outlined">perm_phone_msg</span>
        Clients
      </a>

      <a routerLink="/dashboard/channel-manager" routerLinkActive="bg-primary/10 text-primary"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer">
        <span class="material-symbols-outlined">hub</span>
        Channel Manager
      </a>

      <a routerLink="/dashboard/staff" routerLinkActive="bg-primary/10 text-primary"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer">
        <span class="material-symbols-outlined">group</span>
        Staff
      </a>

      <a routerLink="/dashboard/pnl" routerLinkActive="bg-primary/10 text-primary"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer">
        <span class="material-symbols-outlined">payments</span>
        P&L
      </a>

      <a routerLink="/dashboard/inventory" routerLinkActive="bg-primary/10 text-primary"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer">
        <span class="material-symbols-outlined">inventory_2</span>
        Inventory
      </a>

      <div class="pt-4 mt-4 border-t border-gray-200 dark:border-[#324d67]">
        <a routerLink="/dashboard/db-simulator" routerLinkActive="bg-[#3ECF8E]/10 text-[#3ECF8E]"
          class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer group">
          <span class="material-symbols-outlined group-hover:animate-pulse">database</span>
          DB Simulator
        </a>

        <a routerLink="/dashboard/settings" routerLinkActive="bg-primary/10 text-primary"
          class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer">
          <span class="material-symbols-outlined">settings</span>
          Settings
        </a>

        <a routerLink="/dashboard/communications" routerLinkActive="bg-primary/10 text-primary"
          class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer">
          <span class="material-symbols-outlined">smart_toy</span>
          Chat Simulator
        </a>

        <a routerLink="/dashboard/channel-simulator" routerLinkActive="bg-primary/10 text-primary"
          class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-gray-100 dark:hover:bg-[#253545] hover:text-[#111418] dark:hover:text-white font-medium transition-colors cursor-pointer">
          <span class="material-symbols-outlined">cloud_sync</span>
          Channel Simulator
        </a>
      </div>
    </nav>

    <!-- Bottom Actions -->
    <div class="p-4 border-t border-gray-200 dark:border-[#324d67] flex-shrink-0">
      <div
        class="mb-3 px-3 py-2 bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-lg border border-blue-100 dark:border-blue-900/30">
        <div class="flex justify-between items-center mb-1">
          <span class="text-[10px] font-bold uppercase text-gray-500">Current Plan</span>
          <span class="text-[10px] font-bold px-2 py-0.5 rounded text-white"
            [class.bg-gray-500]="tenant().plan === 'Free'" [class.bg-gradient-to-r]="tenant().plan !== 'Free'"
            [class.from-blue-500]="tenant().plan !== 'Free'" [class.to-purple-600]="tenant().plan !== 'Free'">{{
            tenant().plan }}</span>
        </div>
        <p class="text-[10px] text-gray-500">
          @if(tenant().plan === 'Free') { 1 Unit Limit } @else { Unlimited Units }
        </p>
      </div>
      <button (click)="logout()"
        class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#637588] dark:text-[#92adc9] hover:bg-red-50 dark:hover:bg-red-900/10 hover:text-red-600 font-medium transition-colors cursor-pointer">
        <span class="material-symbols-outlined">logout</span>
        Sign Out
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col min-w-0 overflow-hidden">

    <!-- Top Header -->
    <header
      class="flex items-center justify-between px-6 h-16 bg-white dark:bg-[#1c2936] border-b border-gray-200 dark:border-[#324d67]">
      <button
        class="lg:hidden p-2 -ml-2 text-gray-600 dark:text-gray-300 rounded-md hover:bg-gray-100 dark:hover:bg-[#253545]"
        (click)="toggleSidebar()">
        <span class="material-symbols-outlined">menu</span>
      </button>

      <!-- Right Actions -->
      <div class="flex items-center gap-4 ml-auto">

        <!-- Notification Bell -->
        <div class="relative">
          <button
            class="relative p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-[#253545] rounded-full transition-colors"
            (click)="toggleNotifications()">
            <span class="material-symbols-outlined">notifications</span>
            @if(notifications().length > 0) {
            <span
              class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-white dark:border-[#1c2936]"></span>
            }
          </button>

          <!-- Notification Dropdown -->
          @if (showNotifications()) {
          <div
            class="absolute right-0 mt-2 w-80 bg-white dark:bg-[#1c2936] border border-gray-200 dark:border-[#324d67] rounded-xl shadow-xl z-50 overflow-hidden animate-fade-in origin-top-right">
            <div
              class="p-3 border-b border-gray-200 dark:border-[#324d67] flex justify-between items-center bg-gray-50 dark:bg-[#18232e]">
              <h3 class="font-bold text-sm text-[#111418] dark:text-white">Notifications</h3>
              <span class="text-xs bg-primary/10 text-primary px-2 py-0.5 rounded-full font-bold">{{
                notifications().length }}</span>
            </div>

            <div class="max-h-80 overflow-y-auto">
              @for (notif of notifications(); track notif.id) {
              <div
                class="p-4 border-b border-gray-100 dark:border-[#324d67] last:border-0 hover:bg-gray-50 dark:hover:bg-[#253545] transition-colors relative group">
                <div class="flex gap-3">
                  <div
                    class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 flex-shrink-0">
                    <span class="material-symbols-outlined text-[18px]">person_add</span>
                  </div>
                  <div class="flex-1">
                    <h4 class="text-sm font-bold text-[#111418] dark:text-white">{{ notif.title }}</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 line-clamp-2">{{ notif.message }}</p>
                    <span class="text-[10px] text-gray-400 mt-1 block">{{ notif.timestamp | date:'shortTime' }}</span>

                    <div class="flex gap-2 mt-3">
                      <button (click)="handleNotificationAction(notif)"
                        class="px-3 py-1 bg-primary text-white text-xs font-bold rounded hover:bg-blue-600 transition-colors">
                        {{ notif.data?.pendingClient ? 'Approve & Add' : 'Details' }}
                      </button>
                      <button (click)="dismissNotification($event, notif.id)"
                        class="px-3 py-1 bg-gray-100 dark:bg-[#253545] text-gray-600 dark:text-gray-300 text-xs font-bold rounded hover:bg-gray-200 dark:hover:bg-[#2f4356] transition-colors">
                        Dismiss
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              }
              @if (notifications().length === 0) {
              <div class="p-8 text-center text-gray-400 text-sm">
                No new notifications
              </div>
              }
            </div>
          </div>
          }
        </div>

        <div class="flex items-center gap-3 pl-4 border-l border-gray-200 dark:border-[#324d67]">
          <div class="text-right hidden sm:block">
            <div class="text-sm font-bold text-[#111418] dark:text-white">
              {{ currentUser()?.name || 'Guest' }}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              {{ currentUser()?.role || 'Visitor' }}
            </div>
          </div>
          <img [src]="currentUser()?.avatar || 'https://picsum.photos/100/100'"
            class="w-9 h-9 rounded-full border border-gray-200 dark:border-gray-600 object-cover" alt="Avatar">
        </div>
      </div>
    </header>

    <!-- Scrollable Content -->
    <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
      <router-outlet></router-outlet>
    </main>
  </div>

  <!-- UPGRADE / PAYMENT MODAL -->
  @if (showUpgradeModal()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
    <div
      class="bg-white dark:bg-[#1c2936] w-full max-w-lg rounded-2xl shadow-2xl border border-gray-200 dark:border-[#324d67] overflow-hidden flex flex-col relative">

      <!-- Close Button -->
      <button (click)="closeUpgradeModal()"
        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 z-10">
        <span class="material-symbols-outlined">close</span>
      </button>

      <!-- Content State -->
      @if (!isProcessingPayment()) {
      <div class="p-8 flex flex-col items-center text-center">
        <div
          class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center mb-6 shadow-lg shadow-purple-500/30">
          <span class="material-symbols-outlined text-3xl text-white">diamond</span>
        </div>

        <h2 class="text-2xl font-extrabold text-[#111418] dark:text-white mb-2">Upgrade to PRO</h2>
        <p class="text-gray-500 dark:text-gray-400 mb-6 max-w-xs">
          {{ upgradeReason() }} Unlock unlimited units, staff bots, and AI automation.
        </p>

        <!-- Features -->
        <div
          class="w-full bg-gray-50 dark:bg-[#111a22] rounded-xl p-4 mb-6 text-left border border-gray-100 dark:border-[#324d67]">
          <ul class="space-y-2 text-sm">
            <li class="flex items-center gap-2">
              <span class="material-symbols-outlined text-green-500 text-[18px]">check_circle</span>
              <span class="dark:text-gray-300">Unlimited Properties</span>
            </li>
            <li class="flex items-center gap-2">
              <span class="material-symbols-outlined text-green-500 text-[18px]">check_circle</span>
              <span class="dark:text-gray-300">Staff & AI Chat Bot</span>
            </li>
            <li class="flex items-center gap-2">
              <span class="material-symbols-outlined text-green-500 text-[18px]">check_circle</span>
              <span class="dark:text-gray-300">Advanced Reports</span>
            </li>
          </ul>
        </div>

        <!-- Payment Gateways -->
        <div class="w-full space-y-3">
          <button (click)="selectGateway('stripe')"
            class="w-full flex items-center justify-center gap-3 py-3 border rounded-xl font-bold transition-all"
            [class.border-primary]="selectedGateway() === 'stripe'"
            [class.bg-primary/5]="selectedGateway() === 'stripe'"
            [class.border-gray-200]="selectedGateway() !== 'stripe'"
            [class.dark:border-[#324d67]]="selectedGateway() !== 'stripe'"
            [class.text-[#111418]]="selectedGateway() !== 'stripe'"
            [class.dark:text-white]="selectedGateway() !== 'stripe'">
            <span class="material-symbols-outlined text-blue-600">credit_card</span>
            Pay with Stripe
          </button>

          <button (click)="selectGateway('yukassa')"
            class="w-full flex items-center justify-center gap-3 py-3 border rounded-xl font-bold transition-all"
            [class.border-primary]="selectedGateway() === 'yukassa'"
            [class.bg-primary/5]="selectedGateway() === 'yukassa'"
            [class.border-gray-200]="selectedGateway() !== 'yukassa'"
            [class.dark:border-[#324d67]]="selectedGateway() !== 'yukassa'"
            [class.text-[#111418]]="selectedGateway() !== 'yukassa'"
            [class.dark:text-white]="selectedGateway() !== 'yukassa'">
            <span class="material-symbols-outlined text-orange-500">account_balance_wallet</span>
            Pay with YooKassa
          </button>

          <button (click)="selectGateway('stars')"
            class="w-full flex items-center justify-center gap-3 py-3 border rounded-xl font-bold transition-all"
            [class.border-primary]="selectedGateway() === 'stars'" [class.bg-primary/5]="selectedGateway() === 'stars'"
            [class.border-gray-200]="selectedGateway() !== 'stars'"
            [class.dark:border-[#324d67]]="selectedGateway() !== 'stars'"
            [class.text-[#111418]]="selectedGateway() !== 'stars'"
            [class.dark:text-white]="selectedGateway() !== 'stars'">
            <span class="material-symbols-outlined text-yellow-500">star</span>
            Telegram Stars
          </button>
        </div>

        <button (click)="processPayment()" [disabled]="!selectedGateway()"
          class="w-full mt-6 py-3 bg-primary text-white font-bold rounded-xl shadow-lg shadow-primary/25 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-600 transition-colors">
          Subscribe ($29/mo)
        </button>
      </div>
      } @else {
      <!-- Processing State -->
      <div class="p-12 flex flex-col items-center justify-center text-center h-[500px]">
        <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-6"></div>
        <h3 class="text-xl font-bold text-[#111418] dark:text-white mb-2">Processing Payment...</h3>
        <p class="text-gray-500 dark:text-gray-400 text-sm">Please wait while we confirm your subscription.</p>
      </div>
      }
    </div>
  </div>
  }
</div>